/**
 * This file was auto-generated by Fern from our API Definition.
 */

import { mockServerPool } from "../../mock-server/MockServerPool";
import { phenomlClient } from "../../../src/Client";

describe("Fhir", () => {
    test("search", async () => {
        const server = mockServerPool.createServer();
        const client = new phenomlClient({ token: "test", environment: server.baseUrl });

        const rawResponseBody = {
            resourceType: "Bundle",
            total: 2,
            entry: [{ resource: { resourceType: "Patient", id: "123", name: [{ family: "Doe", given: ["John"] }] } }],
        };
        server
            .mockEndpoint()
            .get("/fhir-provider/fhir_provider_id/fhir/fhir_path")
            .header("X-Phenoml-On-Behalf-Of", "user@example.com")
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.fhir.search("fhir_provider_id", "fhir_path", {
            "X-Phenoml-On-Behalf-Of": "user@example.com",
        });
        expect(response).toEqual({
            resourceType: "Bundle",
            total: 2,
            entry: [
                {
                    resource: {
                        resourceType: "Patient",
                        id: "123",
                        name: [
                            {
                                family: "Doe",
                                given: ["John"],
                            },
                        ],
                    },
                },
            ],
        });
    });

    test("create", async () => {
        const server = mockServerPool.createServer();
        const client = new phenomlClient({ token: "test", environment: server.baseUrl });
        const rawRequestBody = { resourceType: "Patient" };
        const rawResponseBody = {
            resourceType: "Patient",
            id: "123",
            meta: { versionId: "versionId", lastUpdated: "2024-01-15T09:30:00Z", profile: ["profile"] },
        };
        server
            .mockEndpoint()
            .post("/fhir-provider/fhir_provider_id/fhir/fhir_path")
            .header("X-Phenoml-On-Behalf-Of", "user@example.com")
            .jsonBody(rawRequestBody)
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.fhir.create("fhir_provider_id", "fhir_path", {
            "X-Phenoml-On-Behalf-Of": "user@example.com",
            body: {
                resourceType: "Patient",
            },
        });
        expect(response).toEqual({
            resourceType: "Patient",
            id: "123",
            meta: {
                versionId: "versionId",
                lastUpdated: "2024-01-15T09:30:00Z",
                profile: ["profile"],
            },
        });
    });

    test("upsert", async () => {
        const server = mockServerPool.createServer();
        const client = new phenomlClient({ token: "test", environment: server.baseUrl });
        const rawRequestBody = { resourceType: "Patient", id: "123" };
        const rawResponseBody = {
            resourceType: "Patient",
            id: "123",
            meta: { versionId: "versionId", lastUpdated: "2024-01-15T09:30:00Z", profile: ["profile"] },
        };
        server
            .mockEndpoint()
            .put("/fhir-provider/fhir_provider_id/fhir/fhir_path")
            .header("X-Phenoml-On-Behalf-Of", "user@example.com")
            .jsonBody(rawRequestBody)
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.fhir.upsert("fhir_provider_id", "fhir_path", {
            "X-Phenoml-On-Behalf-Of": "user@example.com",
            body: {
                resourceType: "Patient",
                id: "123",
            },
        });
        expect(response).toEqual({
            resourceType: "Patient",
            id: "123",
            meta: {
                versionId: "versionId",
                lastUpdated: "2024-01-15T09:30:00Z",
                profile: ["profile"],
            },
        });
    });

    test("delete", async () => {
        const server = mockServerPool.createServer();
        const client = new phenomlClient({ token: "test", environment: server.baseUrl });

        const rawResponseBody = { key: "value" };
        server
            .mockEndpoint()
            .delete("/fhir-provider/fhir_provider_id/fhir/fhir_path")
            .header("X-Phenoml-On-Behalf-Of", "user@example.com")
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.fhir.delete("fhir_provider_id", "fhir_path", {
            "X-Phenoml-On-Behalf-Of": "user@example.com",
        });
        expect(response).toEqual({
            key: "value",
        });
    });

    test("patch", async () => {
        const server = mockServerPool.createServer();
        const client = new phenomlClient({ token: "test", environment: server.baseUrl });
        const rawRequestBody = [{ op: "replace", path: "/name/0/family", value: "NewFamilyName" }];
        const rawResponseBody = {
            resourceType: "Patient",
            id: "123",
            meta: { versionId: "versionId", lastUpdated: "2024-01-15T09:30:00Z", profile: ["profile"] },
        };
        server
            .mockEndpoint()
            .patch("/fhir-provider/fhir_provider_id/fhir/fhir_path")
            .header("X-Phenoml-On-Behalf-Of", "user@example.com")
            .jsonBody(rawRequestBody)
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.fhir.patch("fhir_provider_id", "fhir_path", {
            "X-Phenoml-On-Behalf-Of": "user@example.com",
            body: [
                {
                    op: "replace",
                    path: "/name/0/family",
                    value: "NewFamilyName",
                },
            ],
        });
        expect(response).toEqual({
            resourceType: "Patient",
            id: "123",
            meta: {
                versionId: "versionId",
                lastUpdated: "2024-01-15T09:30:00Z",
                profile: ["profile"],
            },
        });
    });

    test("executeBundle", async () => {
        const server = mockServerPool.createServer();
        const client = new phenomlClient({ token: "test", environment: server.baseUrl });
        const rawRequestBody = {
            resourceType: "Bundle",
            entry: [
                {
                    resource: { resourceType: "Patient", name: [{ family: "Doe", given: ["John"] }] },
                    request: { method: "POST", url: "Patient" },
                },
                {
                    resource: { resourceType: "Observation", status: "final", subject: { reference: "Patient/123" } },
                    request: { method: "POST", url: "Observation" },
                },
            ],
        };
        const rawResponseBody = {
            resourceType: "Bundle",
            total: 1,
            entry: [
                {
                    resource: { resourceType: "Patient", id: "456" },
                    response: { status: "201 Created", location: "Patient/456" },
                },
            ],
        };
        server
            .mockEndpoint()
            .post("/fhir-provider/fhir_provider_id/fhir")
            .header("X-Phenoml-On-Behalf-Of", "user@example.com")
            .jsonBody(rawRequestBody)
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.fhir.executeBundle("fhir_provider_id", {
            "X-Phenoml-On-Behalf-Of": "user@example.com",
            body: {
                resourceType: "Bundle",
                entry: [
                    {
                        resource: {
                            resourceType: "Patient",
                            name: [
                                {
                                    family: "Doe",
                                    given: ["John"],
                                },
                            ],
                        },
                        request: {
                            method: "POST",
                            url: "Patient",
                        },
                    },
                    {
                        resource: {
                            resourceType: "Observation",
                            status: "final",
                            subject: {
                                reference: "Patient/123",
                            },
                        },
                        request: {
                            method: "POST",
                            url: "Observation",
                        },
                    },
                ],
            },
        });
        expect(response).toEqual({
            resourceType: "Bundle",
            total: 1,
            entry: [
                {
                    resource: {
                        resourceType: "Patient",
                        id: "456",
                    },
                    response: {
                        status: "201 Created",
                        location: "Patient/456",
                    },
                },
            ],
        });
    });
});
